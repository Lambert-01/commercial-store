<%- include('../partials/header') %>

<!-- Enhanced Products Page with Modern Design -->
<section class="min-h-screen bg-gradient-to-br from-neutral-50 to-neutral-100" data-aos="fade-up">
  <div class="container mx-auto px-4 py-6">

    <!-- Request ID for debugging -->
    <% if (typeof requestId !== 'undefined') { %>
      <div class="bg-primary bg-opacity-10 border border-primary border-opacity-20 rounded-lg p-3 mb-6">
        <p class="text-primary text-sm font-medium">Request ID: <%= requestId %></p>
      </div>
    <% } %>

    <!-- Breadcrumb Navigation -->
    <nav class="mb-6" aria-label="Breadcrumb">
      <ol class="flex items-center space-x-2 text-sm text-neutral-600">
        <li><a href="/" class="hover:text-primary transition-colors duration-200">🏠 Home</a></li>
        <li class="text-neutral-400">/</li>
        <li class="text-neutral-900 font-medium">🛍️ Products</li>
      </ol>
    </nav>

    <!-- Page Header with Optimized Typography -->
    <div class="mb-6 bg-white rounded-xl shadow-sm p-6 border border-neutral-200" data-aos="fade-up" data-aos-delay="100">
      <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
        <div class="flex-1">
          <h1 class="text-2xl md:text-3xl font-semibold text-neutral-900 mb-2 flex items-center gap-3">
            <span class="text-3xl">🛍️</span>
            <span class="text-primary">
              Rwandan Marketplace
            </span>
          </h1>
          <p class="text-neutral-600 text-sm leading-relaxed mb-3">
            Discover authentic products from local Rwandan suppliers.
          </p>

          <!-- Quick Stats - Compact -->
          <div class="flex flex-wrap gap-3 text-xs">
            <div class="flex items-center gap-1 bg-primary bg-opacity-10 text-primary px-2 py-1 rounded-full">
              <span class="font-medium"><%= products.length %></span>
              <span>Products</span>
            </div>
            <div class="flex items-center gap-1 bg-success bg-opacity-10 text-success px-2 py-1 rounded-full">
              <span class="font-medium"><%= new Set(products.map(p => p.supplier._id)).size %></span>
              <span>Suppliers</span>
            </div>
          </div>
        </div>

        <!-- Enhanced Featured Categories - Horizontal Layout -->
        <div class="lg:w-auto flex-shrink-0">
          <div class="flex flex-wrap gap-2 justify-center lg:justify-end">
            <div class="category-card group bg-gradient-to-br from-amber-100 via-amber-50 to-yellow-100 p-3 rounded-xl text-center hover:shadow-lg transition-all duration-300 cursor-pointer transform hover:scale-105 hover:-translate-y-1 border border-amber-200 hover:border-amber-300"
                 onclick="filterByCategory('coffee')"
                 data-aos="zoom-in" data-aos-delay="200">
              <div class="relative">
                <span class="text-2xl block mb-1 group-hover:animate-bounce">☕</span>
                <div class="absolute -top-1 -right-1 w-3 h-3 bg-amber-400 rounded-full animate-pulse"></div>
              </div>
              <span class="text-xs font-semibold text-amber-800 group-hover:text-amber-900 transition-colors">Coffee & Tea</span>
              <div class="text-xs text-amber-600 mt-1 opacity-75 group-hover:opacity-100 transition-opacity">
                Premium blends
              </div>
            </div>

            <div class="category-card group bg-gradient-to-br from-pink-100 via-pink-50 to-rose-100 p-3 rounded-xl text-center hover:shadow-lg transition-all duration-300 cursor-pointer transform hover:scale-105 hover:-translate-y-1 border border-pink-200 hover:border-pink-300"
                 onclick="filterByCategory('fashion')"
                 data-aos="zoom-in" data-aos-delay="300">
              <div class="relative">
                <span class="text-2xl block mb-1 group-hover:animate-bounce">👗</span>
                <div class="absolute -top-1 -right-1 w-3 h-3 bg-pink-400 rounded-full animate-pulse"></div>
              </div>
              <span class="text-xs font-semibold text-pink-800 group-hover:text-pink-900 transition-colors">Fashion</span>
              <div class="text-xs text-pink-600 mt-1 opacity-75 group-hover:opacity-100 transition-opacity">
                Traditional wear
              </div>
            </div>

            <div class="category-card group bg-gradient-to-br from-green-100 via-green-50 to-emerald-100 p-3 rounded-xl text-center hover:shadow-lg transition-all duration-300 cursor-pointer transform hover:scale-105 hover:-translate-y-1 border border-green-200 hover:border-green-300"
                 onclick="filterByCategory('food')"
                 data-aos="zoom-in" data-aos-delay="400">
              <div class="relative">
                <span class="text-2xl block mb-1 group-hover:animate-bounce">🥕</span>
                <div class="absolute -top-1 -right-1 w-3 h-3 bg-green-400 rounded-full animate-pulse"></div>
              </div>
              <span class="text-xs font-semibold text-green-800 group-hover:text-green-900 transition-colors">Food</span>
              <div class="text-xs text-green-600 mt-1 opacity-75 group-hover:opacity-100 transition-opacity">
                Fresh produce
              </div>
            </div>

            <div class="category-card group bg-gradient-to-br from-purple-100 via-purple-50 to-violet-100 p-3 rounded-xl text-center hover:shadow-lg transition-all duration-300 cursor-pointer transform hover:scale-105 hover:-translate-y-1 border border-purple-200 hover:border-purple-300"
                 onclick="filterByCategory('crafts')"
                 data-aos="zoom-in" data-aos-delay="500">
              <div class="relative">
                <span class="text-2xl block mb-1 group-hover:animate-bounce">🧺</span>
                <div class="absolute -top-1 -right-1 w-3 h-3 bg-purple-400 rounded-full animate-pulse"></div>
              </div>
              <span class="text-xs font-semibold text-purple-800 group-hover:text-purple-900 transition-colors">Crafts</span>
              <div class="text-xs text-purple-600 mt-1 opacity-75 group-hover:opacity-100 transition-opacity">
                Handmade goods
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Categories Section -->
    <div class="bg-white rounded-xl shadow-sm p-4 mb-6 border border-neutral-200" data-aos="fade-up" data-aos-delay="150">
      <h2 class="text-base font-semibold text-neutral-900 mb-3 flex items-center gap-2">
        <span class="text-lg">🏷️</span>
        Shop by Category
      </h2>

      <% if (typeof categories !== 'undefined' && categories.length > 0) { %>
        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-3">
          <!-- All Categories Option -->
          <button onclick="filterByCategory('')"
                  class="category-btn category-btn-all flex flex-col items-center gap-2 p-3 rounded-lg border-2 border-primary bg-primary bg-opacity-5 hover:bg-opacity-10 transition-all duration-200"
                  data-category="">
            <span class="text-2xl">📦</span>
            <div class="text-center">
              <div class="text-xs font-medium text-primary">All Products</div>
              <div class="text-xs text-neutral-500"><%= products.length %> items</div>
            </div>
          </button>

          <!-- Dynamic Categories from Database -->
          <% categories.forEach(category => { %>
            <button onclick="filterByCategory('<%= category.id %>')"
                    class="category-btn flex flex-col items-center gap-2 p-3 rounded-lg border-2 border-neutral-200 hover:border-primary hover:bg-primary hover:bg-opacity-5 transition-all duration-200"
                    data-category="<%= category.id %>">
              <span class="text-2xl"><%= category.icon %></span>
              <div class="text-center">
                <div class="text-xs font-medium text-neutral-700 category-name"><%= category.name %></div>
                <div class="text-xs text-neutral-500"><%= category.count %> items</div>
              </div>
            </button>
          <% }); %>
        </div>
      <% } else { %>
        <!-- Fallback Categories (when no data from DB) -->
        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-3">
          <button onclick="filterByCategory('')"
                  class="category-btn category-btn-all flex flex-col items-center gap-2 p-3 rounded-lg border-2 border-primary bg-primary bg-opacity-5 transition-all duration-200">
            <span class="text-2xl">📦</span>
            <div class="text-center">
              <div class="text-xs font-medium text-primary">All Products</div>
              <div class="text-xs text-neutral-500"><%= products.length %> items</div>
            </div>
          </button>

          <button onclick="filterByCategory('coffee')"
                  class="category-btn flex flex-col items-center gap-2 p-3 rounded-lg border-2 border-neutral-200 hover:border-primary hover:bg-primary hover:bg-opacity-5 transition-all duration-200">
            <span class="text-2xl">☕</span>
            <div class="text-center">
              <div class="text-xs font-medium text-neutral-700">Coffee & Tea</div>
              <div class="text-xs text-neutral-500">Premium blends</div>
            </div>
          </button>

          <button onclick="filterByCategory('fashion')"
                  class="category-btn flex flex-col items-center gap-2 p-3 rounded-lg border-2 border-neutral-200 hover:border-primary hover:bg-primary hover:bg-opacity-5 transition-all duration-200">
            <span class="text-2xl">👗</span>
            <div class="text-center">
              <div class="text-xs font-medium text-neutral-700">Fashion</div>
              <div class="text-xs text-neutral-500">Clothing & accessories</div>
            </div>
          </button>

          <button onclick="filterByCategory('food')"
                  class="category-btn flex flex-col items-center gap-2 p-3 rounded-lg border-2 border-neutral-200 hover:border-primary hover:bg-primary hover:bg-opacity-5 transition-all duration-200">
            <span class="text-2xl">🥕</span>
            <div class="text-center">
              <div class="text-xs font-medium text-neutral-700">Food</div>
              <div class="text-xs text-neutral-500">Fresh produce</div>
            </div>
          </button>

          <button onclick="filterByCategory('crafts')"
                  class="category-btn flex flex-col items-center gap-2 p-3 rounded-lg border-2 border-neutral-200 hover:border-primary hover:bg-primary hover:bg-opacity-5 transition-all duration-200">
            <span class="text-2xl">🧺</span>
            <div class="text-center">
              <div class="text-xs font-medium text-neutral-700">Crafts</div>
              <div class="text-xs text-neutral-500">Handmade goods</div>
            </div>
          </button>
        </div>
      <% } %>
    </div>

    <!-- Compact Filters and Search Bar -->
    <div class="bg-white rounded-xl shadow-sm p-4 mb-6 border border-neutral-200" data-aos="fade-up" data-aos-delay="200">
      <div class="flex flex-col lg:flex-row gap-4">

        <!-- Search Section - Compact -->
        <div class="flex-1 max-w-2xl">
          <div class="relative">
            <input type="text"
                   id="productSearch"
                   placeholder="Search products..."
                   class="w-full pl-10 pr-8 py-2.5 text-sm border border-neutral-300 rounded-lg focus:ring-1 focus:ring-primary focus:border-primary transition-all duration-200">
            <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-neutral-400">🔍</span>
            <button onclick="clearSearch()" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-neutral-400 hover:text-neutral-600" title="Clear search">
              <span class="text-sm">✕</span>
            </button>
          </div>
        </div>

        <!-- Compact Filters -->
        <div class="flex flex-col sm:flex-row gap-2 lg:gap-2">

          <!-- Category Filter - Compact -->
          <div class="relative">
            <select id="categoryFilter" class="appearance-none bg-neutral-50 border border-neutral-300 rounded-lg px-3 py-2.5 pr-8 focus:ring-1 focus:ring-primary focus:border-primary transition-all duration-200 text-sm min-w-32">
              <option value="">All Categories</option>
              <option value="coffee">☕ Coffee & Tea</option>
              <option value="fashion">👗 Fashion</option>
              <option value="food">🥕 Food</option>
              <option value="crafts">🧺 Crafts</option>
            </select>
            <div class="absolute right-2 top-1/2 transform -translate-y-1/2 text-neutral-400 pointer-events-none">
              <span class="text-xs">▼</span>
            </div>
          </div>

          <!-- Sort Options - Compact -->
          <div class="relative">
            <select id="sortFilter" class="appearance-none bg-neutral-50 border border-neutral-300 rounded-lg px-3 py-2.5 pr-8 focus:ring-1 focus:ring-primary focus:border-primary transition-all duration-200 text-sm min-w-28">
              <option value="featured">Featured</option>
              <option value="name">Name A-Z</option>
              <option value="price-low">Price: Low to High</option>
              <option value="price-high">Price: High to Low</option>
              <option value="newest">Newest</option>
            </select>
            <div class="absolute right-2 top-1/2 transform -translate-y-1/2 text-neutral-400 pointer-events-none">
              <span class="text-xs">▼</span>
            </div>
          </div>

          <!-- Filter Actions - Compact -->
          <div class="flex gap-1">
            <button onclick="applyFilters()"
                    class="bg-primary hover:bg-primary-600 text-white px-3 py-2.5 rounded-lg transition-all duration-200 text-sm font-medium">
              Apply
            </button>
            <button onclick="clearAllFilters()"
                    class="bg-neutral-200 hover:bg-neutral-300 text-neutral-700 px-2 py-2.5 rounded-lg transition-all duration-200 text-sm">
              Clear
            </button>
          </div>
        </div>
      </div>

      <!-- Filter Summary - Compact -->
      <div class="mt-3 pt-3 border-t border-neutral-200">
        <div class="flex items-center justify-between text-xs text-neutral-600">
          <span id="filterSummary">Showing all <%= products.length %> products</span>
          <div class="flex items-center gap-3">
            <label class="flex items-center gap-1 cursor-pointer">
              <input type="checkbox" id="showOnlyInStock" class="rounded text-primary focus:ring-primary text-xs">
              <span class="text-xs">In Stock Only</span>
            </label>
          </div>
        </div>
      </div>
    </div>

    <% if (products && products.length > 0) { %>
      <!-- Enhanced Products Grid -->
      <div id="productsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-6">

        <% products.forEach((product, index) => { %>
          <div class="product-card-compact group relative bg-white rounded-xl shadow-sm hover:shadow-lg transition-all duration-300 border border-neutral-200 overflow-hidden"
                data-aos="fade-up"
                data-aos-delay="<%= 100 + (index * 50) %>"
                data-product-id="<%= product._id %>">

            <!-- Product Image Section - Compact -->
            <div class="relative h-32 bg-gradient-to-br from-neutral-50 to-neutral-100 overflow-hidden">
              <!-- Main Product Image -->
              <div class="w-full h-full flex items-center justify-center text-3xl">
                <%= getProductIcon(product.name) %>
              </div>

              <!-- Wishlist Button - Smaller -->
              <button onclick="toggleWishlist('<%= product._id %>')"
                      class="absolute top-2 left-2 w-7 h-7 bg-white bg-opacity-90 hover:bg-opacity-100 rounded-full flex items-center justify-center shadow-sm transition-all duration-200"
                      title="Add to Wishlist">
                <span id="wishlist-icon-<%= product._id %>" class="text-sm">🤍</span>
              </button>

              <!-- Stock Badge - Compact -->
              <% if (product.stock < 10 && product.stock > 0) { %>
                <div class="absolute top-2 right-2 bg-orange-500 text-white px-2 py-0.5 rounded-full text-xs font-medium">
                  Low Stock
                </div>
              <% } %>

              <!-- Out of Stock Badge -->
              <% if (product.stock === 0) { %>
                <div class="absolute inset-0 bg-neutral-900 bg-opacity-50 flex items-center justify-center">
                  <span class="text-white text-xs font-medium bg-neutral-900 bg-opacity-75 px-2 py-1 rounded">Out of Stock</span>
                </div>
              <% } %>
            </div>

            <!-- Product Info - Compact -->
            <div class="p-3">
              <!-- Product Title and Supplier -->
              <div class="mb-2">
                <h3 class="text-sm font-semibold text-neutral-900 line-clamp-1 leading-tight mb-1">
                  <%= product.name %>
                </h3>
                <div class="flex items-center gap-1">
                  <span class="text-xs text-neutral-500">by</span>
                  <a href="/products/supplier/<%= product.supplier._id %>"
                     class="text-xs text-primary hover:text-primary-600 font-medium transition-colors duration-200">
                    <%= product.supplier?.name || 'Unknown Supplier' %>
                  </a>
                </div>
              </div>

              <!-- Price and Stock Status -->
              <div class="flex items-center justify-between mb-2">
                <div class="text-base font-bold text-rwanda-yellow">
                  <%= product.price.toLocaleString() %> RWF
                </div>
                <% if (product.stock > 0) { %>
                  <div class="flex items-center gap-1">
                    <span class="w-1.5 h-1.5 bg-success rounded-full"></span>
                    <span class="text-xs text-success font-medium"><%= product.stock %> left</span>
                  </div>
                <% } %>
              </div>

              <!-- Action Buttons - Compact -->
              <div class="flex gap-1">
                <a href="/product/<%= product._id %>"
                   class="flex-1 bg-primary hover:bg-primary-600 text-white text-center py-2 px-2 rounded-lg transition-all duration-200 text-xs font-medium">
                  View
                </a>

                <% if (isAuthenticated && product.stock > 0) { %>
                  <button onclick="addToCart('<%= product._id %>', '<%= product.name %>')"
                          class="bg-rwanda-yellow hover:bg-yellow-400 text-neutral-900 py-2 px-2 rounded-lg text-xs font-medium transition-all duration-200"
                          title="Add to cart">
                    🛒
                  </button>
                <% } else if (product.stock === 0) { %>
                  <button class="bg-neutral-200 text-neutral-400 py-2 px-2 rounded-lg text-xs cursor-not-allowed"
                          disabled>
                    ✕
                  </button>
                <% } else { %>
                  <a href="/login"
                     class="bg-rwanda-yellow hover:bg-yellow-400 text-neutral-900 py-2 px-2 rounded-lg text-xs font-medium transition-all duration-200">
                    🔒
                  </a>
                <% } %>
              </div>
            </div>
          </div>
        <% }); %>
      </div>

      <!-- Enhanced Products Summary & Analytics -->
      <div class="mt-16 grid grid-cols-1 lg:grid-cols-3 gap-8">

        <!-- Products Summary -->
        <div class="bg-white rounded-2xl shadow-xl p-8 border border-neutral-200" data-aos="fade-up" data-aos-delay="800">
          <div class="text-center">
            <div class="w-16 h-16 bg-primary bg-opacity-10 rounded-full flex items-center justify-center text-2xl mx-auto mb-4">
              📊
            </div>
            <h3 class="text-2xl font-bold text-neutral-900 mb-2">
              <%= products.length %> Products Found
            </h3>
            <p class="text-neutral-600 mb-6">
              From <%= new Set(products.map(p => p.supplier._id)).size %> trusted Rwandan suppliers
            </p>

            <!-- Quick Stats -->
            <div class="grid grid-cols-2 gap-4 text-center">
              <div class="bg-neutral-50 rounded-xl p-4">
                <div class="text-2xl font-bold text-primary"><%= products.filter(p => p.featured).length %></div>
                <div class="text-sm text-neutral-600">Featured</div>
              </div>
              <div class="bg-neutral-50 rounded-xl p-4">
                <div class="text-2xl font-bold text-success"><%= products.filter(p => p.stock > 0).length %></div>
                <div class="text-sm text-neutral-600">In Stock</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Trending Products -->
        <div class="bg-white rounded-2xl shadow-xl p-8 border border-neutral-200" data-aos="fade-up" data-aos-delay="900">
          <div class="text-center">
            <div class="w-16 h-16 bg-rwanda-yellow bg-opacity-10 rounded-full flex items-center justify-center text-2xl mx-auto mb-4">
              🔥
            </div>
            <h3 class="text-2xl font-bold text-neutral-900 mb-2">
              Trending Now
            </h3>
            <p class="text-neutral-600 mb-6">
              Most popular products this week
            </p>

            <!-- Top Products -->
            <div class="space-y-3">
              <% const trendingProducts = products.filter(p => p.featured || p.stock > 50).slice(0, 3); %>
              <% trendingProducts.forEach((product, index) => { %>
                <div class="flex items-center gap-3 p-3 bg-neutral-50 rounded-xl hover:bg-neutral-100 transition-colors duration-200">
                  <div class="w-8 h-8 bg-primary bg-opacity-10 rounded-full flex items-center justify-center text-sm font-bold text-primary">
                    <%= index + 1 %>
                  </div>
                  <div class="flex-1 text-left">
                    <div class="font-semibold text-neutral-900 text-sm truncate"><%= product.name %></div>
                    <div class="text-xs text-neutral-600"><%= product.price.toLocaleString() %> RWF</div>
                  </div>
                  <div class="text-xs text-success font-medium">↗ <%= Math.floor(Math.random() * 50) + 10 %>%</div>
                </div>
              <% }); %>
            </div>
          </div>
        </div>

        <!-- Recently Viewed -->
        <div class="bg-white rounded-2xl shadow-xl p-8 border border-neutral-200" data-aos="fade-up" data-aos-delay="1000">
          <div class="text-center">
            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center text-2xl mx-auto mb-4">
              👁️
            </div>
            <h3 class="text-2xl font-bold text-neutral-900 mb-2">
              Recently Viewed
            </h3>
            <p class="text-neutral-600 mb-6">
              Your browsing history
            </p>

            <div id="recentlyViewed" class="space-y-3">
              <p class="text-sm text-neutral-500">No recently viewed products</p>
              <p class="text-xs text-neutral-400">Products you view will appear here</p>
            </div>
          </div>
        </div>
      </div>

    <% } else { %>
      <!-- Enhanced Empty State -->
      <div class="text-center py-20" data-aos="fade-up" data-aos-delay="200">
        <div class="max-w-2xl mx-auto">

          <!-- Loading Skeleton (when filtering) -->
          <div id="loadingSkeleton" class="hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 mb-8">
              <% for (let i = 0; i < 8; i++) { %>
                <div class="bg-white rounded-2xl shadow-lg p-6 animate-pulse">
                  <div class="h-56 bg-neutral-200 rounded-xl mb-4"></div>
                  <div class="space-y-3">
                    <div class="h-4 bg-neutral-200 rounded w-3/4"></div>
                    <div class="h-3 bg-neutral-200 rounded w-1/2"></div>
                    <div class="h-6 bg-neutral-200 rounded w-full"></div>
                    <div class="h-10 bg-neutral-200 rounded w-full"></div>
                  </div>
                </div>
              <% } %>
            </div>
          </div>

          <!-- No Results State -->
          <div id="noResultsState" class="hidden">
            <div class="w-40 h-40 bg-gradient-to-br from-neutral-200 to-neutral-300 rounded-full flex items-center justify-center text-8xl mx-auto mb-8 animate-bounce">
              🔍
            </div>
            <h2 class="text-3xl md:text-4xl font-bold text-neutral-900 mb-4">
              No Products Found
            </h2>
            <p class="text-neutral-600 text-lg mb-8 max-w-lg mx-auto">
              We couldn't find any products matching your search criteria. Try adjusting your filters or search terms.
            </p>
            <button onclick="clearAllFilters()"
                    class="bg-primary hover:bg-primary-600 text-white px-8 py-4 rounded-xl transition-all duration-300 hover:shadow-lg transform hover:-translate-y-0.5 font-semibold">
              🗑️ Clear All Filters
            </button>
          </div>

          <!-- No Products Available State -->
          <div id="noProductsState">
            <div class="w-40 h-40 bg-gradient-to-br from-rwanda-yellow to-yellow-300 rounded-full flex items-center justify-center text-8xl mx-auto mb-8 animate-bounce">
              📦
            </div>
            <h2 class="text-3xl md:text-4xl font-bold text-neutral-900 mb-4">
              No Products Available
            </h2>
            <p class="text-neutral-600 text-lg mb-8 max-w-lg mx-auto">
              We're working with local suppliers to bring you amazing Rwandan products. Check back soon for new arrivals!
            </p>

            <div class="flex flex-col sm:flex-row gap-4 justify-center items-center">
              <% if (isSupplier) { %>
                <div class="bg-primary bg-opacity-10 border-2 border-primary border-opacity-20 rounded-2xl p-6 text-center">
                  <div class="w-12 h-12 bg-primary bg-opacity-10 rounded-full flex items-center justify-center text-xl mx-auto mb-3">
                    🏪
                  </div>
                  <h3 class="font-bold text-primary mb-2">Are you a supplier?</h3>
                  <p class="text-neutral-600 text-sm mb-4">Join our marketplace and showcase your products</p>
                  <a href="/supplier/add-product"
                     class="bg-primary hover:bg-primary-600 text-white px-6 py-3 rounded-xl transition-all duration-300 hover:shadow-lg transform hover:-translate-y-0.5 font-semibold inline-block">
                    ➕ Add Your Products
                  </a>
                </div>
              <% } %>

              <% if (isAdmin) { %>
                <div class="bg-warning bg-opacity-10 border-2 border-warning border-opacity-20 rounded-2xl p-6 text-center">
                  <div class="w-12 h-12 bg-warning bg-opacity-10 rounded-full flex items-center justify-center text-xl mx-auto mb-3">
                    ⚙️
                  </div>
                  <h3 class="font-bold text-warning-800 mb-2">Admin Action Required</h3>
                  <p class="text-neutral-600 text-sm mb-4">Products are pending approval in the system</p>
                  <a href="/admin-portal/products"
                     class="bg-warning hover:bg-yellow-500 text-white px-6 py-3 rounded-xl transition-all duration-300 hover:shadow-lg transform hover:-translate-y-0.5 font-semibold inline-block">
                    Review Products
                  </a>
                </div>
              <% } %>
            </div>
          </div>
        </div>
      </div>
    <% } %>

    <!-- Enhanced Featured Suppliers Section - Horizontal Layout -->
    <% if (products && products.length > 0) { %>
      <div class="mt-8" data-aos="fade-up" data-aos-delay="900">
        <div class="bg-gradient-to-r from-primary via-primary-600 to-rwanda-yellow rounded-2xl p-6 text-white relative overflow-hidden">
          <!-- Background Pattern -->
          <div class="absolute inset-0 opacity-10">
            <div class="absolute top-4 left-4 text-6xl animate-pulse">🏪</div>
            <div class="absolute top-8 right-8 text-4xl animate-pulse" style="animation-delay: 1s;">🛍️</div>
            <div class="absolute bottom-4 left-8 text-5xl animate-pulse" style="animation-delay: 2s;">⭐</div>
          </div>

          <div class="relative">
            <h2 class="text-xl md:text-2xl font-bold text-center mb-6 flex items-center justify-center gap-2">
              <span class="text-2xl animate-bounce">🏆</span>
              Featured Suppliers
              <span class="text-2xl animate-bounce" style="animation-delay: 0.5s;">✨</span>
            </h2>

            <div class="flex flex-wrap justify-center gap-4">
              <% const suppliers = [...new Set(products.map(p => p.supplier._id))].slice(0, 4); %>
              <% suppliers.forEach((supplierId, index) => { %>
                <% const supplierProducts = products.filter(p => p.supplier._id.toString() === supplierId.toString()); %>
                <% const supplier = supplierProducts[0]?.supplier; %>
                <% if (supplier) { %>
                  <div class="supplier-card group bg-white bg-opacity-95 backdrop-blur-sm rounded-xl p-4 text-center hover:bg-opacity-100 transition-all duration-300 transform hover:scale-105 hover:-translate-y-2 shadow-lg hover:shadow-xl border border-white border-opacity-20"
                       data-aos="fade-up" data-aos-delay="<%= 1000 + (index * 100) %>"
                       style="min-width: 200px;">

                    <!-- Animated Avatar -->
                    <div class="relative mx-auto mb-3">
                      <div class="w-14 h-14 bg-gradient-to-br from-primary to-primary-600 rounded-full flex items-center justify-center text-xl shadow-lg group-hover:shadow-xl transition-all duration-300 group-hover:scale-110">
                        🏪
                      </div>
                      <div class="absolute -top-1 -right-1 w-4 h-4 bg-success rounded-full border-2 border-white animate-pulse"></div>
                    </div>

                    <!-- Supplier Info -->
                    <h3 class="text-sm font-bold text-neutral-900 mb-1 group-hover:text-primary transition-colors duration-300">
                      <%= supplier.name %>
                    </h3>

                    <p class="text-xs text-neutral-600 mb-3 group-hover:text-neutral-700 transition-colors">
                      <%= supplierProducts.length %> product<%= supplierProducts.length !== 1 ? 's' : '' %> available
                    </p>

                    <!-- Enhanced Button -->
                    <a href="/products/supplier/<%= supplier._id %>"
                       class="inline-flex items-center gap-1 bg-rwanda-yellow hover:bg-yellow-400 text-neutral-900 text-xs font-semibold px-3 py-2 rounded-lg transition-all duration-300 hover:shadow-md transform hover:scale-105">
                      <span>🛒</span>
                      Visit Store
                    </a>

                    <!-- Decorative Elements -->
                    <div class="absolute top-2 right-2 opacity-20 group-hover:opacity-40 transition-opacity">
                      <span class="text-lg">✨</span>
                    </div>
                  </div>
                <% } %>
              <% }); %>
            </div>

            <!-- Call to Action -->
            <div class="text-center mt-6">
              <a href="/suppliers"
                 class="inline-flex items-center gap-2 bg-white bg-opacity-20 hover:bg-opacity-30 text-white text-sm font-semibold px-4 py-2 rounded-lg transition-all duration-300 hover:scale-105 backdrop-blur-sm">
                <span>🏪</span>
                View All Suppliers
              </a>
            </div>
          </div>
        </div>
      </div>
    <% } %>

  </div>
</section>

    <!-- Products Data for JavaScript -->
    <div id="productsData" style="display: none;"><%= JSON.stringify(products) %></div>

    <!-- Enhanced JavaScript Functionality -->
    <script>
      // Enhanced Product category detection
      function getProductCategory(productName) {
        const name = productName.toLowerCase();
        if (name.includes('coffee') || name.includes('tea')) return 'coffee';
        if (name.includes('dress') || name.includes('shirt') || name.includes('necklace') || name.includes('kitenge')) return 'fashion';
        if (name.includes('banana') || name.includes('honey') || name.includes('food') || name.includes('spiced') || name.includes('avocado')) return 'food';
        if (name.includes('basket') || name.includes('pottery') || name.includes('carving') || name.includes('wall') || name.includes('woven')) return 'crafts';
        return 'other';
      }

      // Enhanced Product icon selection
      function getProductIcon(productName) {
        const name = productName.toLowerCase();
        if (name.includes('coffee')) return '☕';
        if (name.includes('tea')) return '🍵';
        if (name.includes('dress')) return '👗';
        if (name.includes('shirt')) return '👔';
        if (name.includes('necklace')) return '📿';
        if (name.includes('banana')) return '🍌';
        if (name.includes('honey')) return '🍯';
        if (name.includes('basket')) return '🧺';
        if (name.includes('pottery') || name.includes('vase')) return '🏺';
        if (name.includes('carving') || name.includes('wooden')) return '🪵';
        return '📦';
      }

      // Global state management
      const originalProducts = JSON.parse(document.getElementById('productsData').textContent);
      let filteredProducts = [...originalProducts];
      let wishlist = JSON.parse(localStorage.getItem('rwanda-wishlist')) || [];
      let recentlyViewed = JSON.parse(localStorage.getItem('rwanda-recently-viewed')) || [];
      let currentCategory = '';

      // Category filtering functionality
      function filterByCategory(categoryId) {
        console.log('🏷️ Filtering by category:', categoryId);

        // Update current category
        currentCategory = categoryId;

        // Update button states
        document.querySelectorAll('.category-btn').forEach(btn => {
          btn.classList.remove('border-primary', 'bg-primary', 'bg-opacity-5');
          if (btn.dataset.category === categoryId) {
            btn.classList.add('border-primary', 'bg-primary', 'bg-opacity-5');
          } else if (categoryId === '' && btn.classList.contains('category-btn-all')) {
            btn.classList.add('border-primary', 'bg-primary', 'bg-opacity-5');
          }
        });

        // Apply all filters including category
        applyFilters();
      }

      // Enhanced filtering and search functionality
      function applyFilters() {
        console.log('🔍 Applying filters...');

        const searchTerm = document.getElementById('productSearch').value.toLowerCase();
        const categoryFilter = document.getElementById('categoryFilter').value;
        const priceRangeFilter = document.getElementById('priceRangeFilter').value;
        const sortFilter = document.getElementById('sortFilter').value;
        const showOnlyInStock = document.getElementById('showOnlyInStock').checked;
        const showOnlyFeatured = document.getElementById('showOnlyFeatured').checked;

        // Start with all products
        filteredProducts = [...originalProducts];

        // Apply category filter (from button clicks)
        if (currentCategory) {
          filteredProducts = filteredProducts.filter(product =>
            product.category === currentCategory
          );
        }

        // Apply search filter
        if (searchTerm) {
          filteredProducts = filteredProducts.filter(product =>
            product.name.toLowerCase().includes(searchTerm) ||
            product.description.toLowerCase().includes(searchTerm) ||
            (product.supplier && product.supplier.name.toLowerCase().includes(searchTerm)) ||
            (product.tags && product.tags.some(tag => tag.toLowerCase().includes(searchTerm)))
          );
        }

        // Apply category filter (from dropdown)
        if (categoryFilter) {
          filteredProducts = filteredProducts.filter(product =>
            (product.category && product.category === categoryFilter) ||
            getProductCategory(product.name) === categoryFilter
          );
        }

        // Apply price range filter
        if (priceRangeFilter) {
          filteredProducts = filteredProducts.filter(product => {
            const [min, max] = priceRangeFilter.split('-').map(v => v === '+' ? Infinity : parseInt(v));
            return product.price >= min && (max === '+' || product.price <= max);
          });
        }

        // Apply stock filter
        if (showOnlyInStock) {
          filteredProducts = filteredProducts.filter(product => product.stock > 0);
        }

        // Apply featured filter
        if (showOnlyFeatured) {
          filteredProducts = filteredProducts.filter(product => product.featured);
        }

        // Apply sorting
        switch (sortFilter) {
          case 'price-low':
            filteredProducts.sort((a, b) => a.price - b.price);
            break;
          case 'price-high':
            filteredProducts.sort((a, b) => b.price - a.price);
            break;
          case 'name':
            filteredProducts.sort((a, b) => a.name.localeCompare(b.name));
            break;
          case 'rating':
            filteredProducts.sort((a, b) => (b.rating || 0) - (a.rating || 0));
            break;
          case 'stock':
            filteredProducts.sort((a, b) => b.stock - a.stock);
            break;
          case 'popular':
            filteredProducts.sort((a, b) => (b.reviewCount || 0) - (a.reviewCount || 0));
            break;
          case 'featured':
            filteredProducts.sort((a, b) => (b.featured ? 1 : 0) - (a.featured ? 1 : 0));
            break;
          case 'newest':
          default:
            filteredProducts.sort((a, b) => new Date(b.createdAt || Date.now()) - new Date(a.createdAt || Date.now()));
            break;
        }

        // Update active filters display
        updateActiveFiltersDisplay();

        // Update filter summary
        updateFilterSummary();

        // Re-render products grid
        renderProductsGrid();

        console.log(`✅ Filtered to ${filteredProducts.length} products`);
      }

      // Update active filters display
      function updateActiveFiltersDisplay() {
        const activeFiltersContainer = document.getElementById('activeFilters');
        const searchTerm = document.getElementById('productSearch').value;
        const categoryFilter = document.getElementById('categoryFilter').value;
        const priceRangeFilter = document.getElementById('priceRangeFilter').value;
        const showOnlyInStock = document.getElementById('showOnlyInStock').checked;
        const showOnlyFeatured = document.getElementById('showOnlyFeatured').checked;

        const activeFilters = [];

        if (searchTerm) {
          activeFilters.push(`<span class="bg-primary bg-opacity-10 text-primary px-3 py-1 rounded-full text-sm">Search: "${searchTerm}"</span>`);
        }
        if (categoryFilter) {
          activeFilters.push(`<span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm">Category: ${categoryFilter}</span>`);
        }
        if (priceRangeFilter) {
          activeFilters.push(`<span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm">Price: ${priceRangeFilter}</span>`);
        }
        if (showOnlyInStock) {
          activeFilters.push(`<span class="bg-orange-100 text-orange-800 px-3 py-1 rounded-full text-sm">In Stock Only</span>`);
        }
        if (showOnlyFeatured) {
          activeFilters.push(`<span class="bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-sm">Featured Only</span>`);
        }

        if (activeFilters.length > 0) {
          activeFiltersContainer.innerHTML = activeFilters.join('');
          activeFiltersContainer.classList.remove('hidden');
        } else {
          activeFiltersContainer.classList.add('hidden');
        }
      }

      // Update filter summary
      function updateFilterSummary() {
        const summary = document.getElementById('filterSummary');
        const totalProducts = originalProducts.length;

        if (filteredProducts.length === totalProducts) {
          summary.textContent = `Showing all ${totalProducts} products`;
        } else {
          summary.textContent = `Showing ${filteredProducts.length} of ${totalProducts} products`;
        }
      }

      // Enhanced products grid rendering
      function renderProductsGrid() {
        const grid = document.getElementById('productsGrid');

        if (filteredProducts.length === 0) {
          showNoResultsState();
          return;
        }

        hideEmptyStates();

        grid.innerHTML = filteredProducts.map((product, index) => `
          <div class="product-card group relative bg-white rounded-2xl shadow-lg hover:shadow-2xl transition-all duration-500 transform hover:-translate-y-3 border border-neutral-200 overflow-hidden"
               data-aos="fade-up"
               data-aos-delay="${100 + (index * 50)}"
               data-category="${product.category || getProductCategory(product.name)}"
               data-price="${product.price}"
               data-stock="${product.stock}"
               data-rating="${product.rating || 4.5}"
               data-product-id="${product._id}">

            <!-- Product Image Section -->
            <div class="relative h-56 bg-gradient-to-br from-neutral-100 to-neutral-200 overflow-hidden">
              <div class="w-full h-full flex items-center justify-center text-6xl bg-white">
                ${getProductIcon(product.name)}
              </div>

              <!-- Wishlist Button -->
              <button onclick="toggleWishlist('${product._id}')"
                      class="absolute top-3 left-3 w-10 h-10 bg-white bg-opacity-90 hover:bg-opacity-100 rounded-full flex items-center justify-center shadow-lg transition-all duration-300 transform hover:scale-110"
                      title="Add to Wishlist">
                <span id="wishlist-icon-${product._id}" class="text-lg ${wishlist.includes(product._id) ? 'text-red-500' : 'text-neutral-600'}"> ${wishlist.includes(product._id) ? '❤️' : '🤍'}</span>
              </button>

              <!-- Stock Badge -->
              ${product.stock < 10 ? `
                <div class="absolute top-3 right-3 bg-gradient-to-r from-orange-400 to-red-400 text-white px-3 py-1.5 rounded-full text-xs font-bold shadow-lg animate-pulse">
                  ⚠️ Low Stock
                </div>
              ` : ''}

              <!-- Featured Badge -->
              ${product.featured ? `
                <div class="absolute bottom-3 left-3 bg-gradient-to-r from-rwanda-yellow to-yellow-400 text-rwanda-yellow px-3 py-1.5 rounded-full text-xs font-bold shadow-lg">
                  🌟 Featured
                </div>
              ` : ''}

              <!-- Quick Actions Overlay -->
              <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-30 transition-all duration-300 flex items-center justify-center">
                <div class="flex gap-3 opacity-0 group-hover:opacity-100 transform translate-y-4 group-hover:translate-y-0 transition-all duration-300">
                  <a href="/product/${product._id}"
                     class="bg-white text-neutral-900 px-4 py-2.5 rounded-xl text-sm font-semibold hover:bg-neutral-50 transition-all duration-200 shadow-lg hover:shadow-xl transform hover:scale-105">
                    👁️ Quick View
                  </a>
                  ${isAuthenticated && product.stock > 0 ? `
                    <button onclick="addToCartQuick('${product._id}')"
                            class="bg-primary text-white px-4 py-2.5 rounded-xl text-sm font-semibold hover:bg-primary-600 transition-all duration-200 shadow-lg hover:shadow-xl transform hover:scale-105">
                      🛒 Add to Cart
                    </button>
                  ` : ''}
                </div>
              </div>

              <!-- Rating Badge -->
              <div class="absolute bottom-3 right-3 bg-white bg-opacity-95 px-2 py-1 rounded-lg shadow-lg">
                <div class="flex items-center gap-1">
                  <span class="text-yellow-400 text-sm">⭐</span>
                  <span class="text-xs font-semibold text-neutral-700">${product.rating || 4.5}</span>
                  <span class="text-xs text-neutral-500">(${product.reviewCount || 0})</span>
                </div>
              </div>
            </div>

            <!-- Enhanced Product Info Card -->
            <div class="p-6">
              <div class="mb-3">
                <div class="flex items-start justify-between mb-2">
                  <div class="flex-1">
                    <h3 class="text-lg font-bold text-neutral-900 line-clamp-2 leading-tight mb-1">
                      ${product.name}
                    </h3>
                    <span class="inline-block bg-neutral-100 text-neutral-600 text-xs px-2 py-1 rounded-full">
                      ${(product.category || getProductCategory(product.name)).toUpperCase()}
                    </span>
                  </div>
                  ${product.stock > 50 ? `
                    <span class="bg-gradient-to-r from-orange-400 to-red-400 text-white px-2 py-1 rounded-full text-xs font-bold animate-pulse">
                      🔥 Popular
                    </span>
                  ` : ''}
                </div>
              </div>

              <div class="flex items-center gap-2 mb-3">
                <div class="flex items-center gap-1">
                  ${Array.from({length: 5}, (_, i) => `
                    <span class="text-${i < (product.rating || 4.5) ? 'yellow-400' : 'neutral-300'} text-sm">${i < (product.rating || 4.5) ? '★' : '☆'}</span>
                  `).join('')}
                </div>
                <span class="text-sm font-semibold text-neutral-700">${product.rating || 4.5}</span>
                <span class="text-xs text-neutral-500">(${product.reviewCount || 0} reviews)</span>
              </div>

              <p class="text-neutral-600 text-sm mb-4 line-clamp-2 leading-relaxed">
                ${product.description}
              </p>

              <div class="flex items-center gap-3 mb-4 p-3 bg-gradient-to-r from-neutral-50 to-neutral-100 rounded-xl border border-neutral-200">
                <div class="w-8 h-8 bg-primary bg-opacity-10 rounded-full flex items-center justify-center">
                  <span class="text-sm">🏪</span>
                </div>
                <div class="flex-1">
                  <a href="/products/supplier/${product.supplier._id}"
                     class="text-primary hover:text-primary-600 font-semibold text-sm transition-colors duration-200 block">
                    ${product.supplier?.name || 'Unknown Supplier'}
                  </a>
                  <div class="flex items-center gap-2">
                    <span class="text-neutral-500 text-xs">⭐ ${product.supplier?.rating || 4.5} Verified Supplier</span>
                    ${product.supplier?.location ? `<span class="text-neutral-400 text-xs">📍 ${product.supplier.location}</span>` : ''}
                  </div>
                </div>
              </div>

              <div class="mb-4">
                <div class="flex items-center justify-between mb-2">
                  <div class="text-2xl font-bold text-rwanda-yellow">
                    ${product.price.toLocaleString()} RWF
                  </div>
                  <div class="text-right">
                    <div class="text-sm ${product.stock > 0 ? 'text-success' : 'text-error'} font-semibold flex items-center gap-1">
                      <span class="w-2 h-2 ${product.stock > 0 ? 'bg-success' : 'bg-error'} rounded-full"></span>
                      ${product.stock > 0 ? `${product.stock} in stock` : 'Out of stock'}
                    </div>
                  </div>
                </div>

                <div class="w-full h-2 bg-neutral-200 rounded-full overflow-hidden mb-3">
                  <div class="h-full bg-gradient-to-r ${product.stock > 50 ? 'from-success to-green-400' : product.stock > 20 ? 'from-warning to-yellow-400' : 'from-error to-red-400'} rounded-full transition-all duration-500"
                       style="width: ${Math.min((product.stock / 100) * 100, 100)}%"></div>
                </div>
              </div>

              <div class="space-y-3">
                <div class="flex gap-2">
                  <a href="/product/${product._id}"
                     class="flex-1 bg-primary hover:bg-primary-600 text-white text-center py-3 px-4 rounded-xl transition-all duration-300 text-sm font-semibold hover:shadow-lg transform hover:-translate-y-0.5">
                    View Details
                  </a>

                  ${isAuthenticated && product.stock > 0 ? `
                    <button onclick="addToCart('${product._id}', '${product.name}')"
                            class="bg-rwanda-yellow hover:bg-yellow-400 text-neutral-900 py-3 px-3 rounded-xl text-sm font-semibold hover:shadow-lg transform hover:-translate-y-0.5 transition-all duration-300"
                            title="Add to cart">
                      🛒
                    </button>
                  ` : product.stock === 0 ? `
                    <button class="bg-neutral-300 text-neutral-500 py-3 px-3 rounded-xl text-sm cursor-not-allowed"
                            disabled
                            title="Out of stock">
                      🚫
                    </button>
                  ` : `
                    <a href="/login"
                       class="bg-rwanda-yellow hover:bg-yellow-400 text-neutral-900 py-3 px-3 rounded-xl text-sm font-semibold hover:shadow-lg transform hover:-translate-y-0.5 transition-all duration-300"
                       title="Login to add to cart">
                      🔒
                    </a>
                  `}
                </div>

                <div class="flex items-center justify-between text-xs text-neutral-500 pt-2 border-t border-neutral-200">
                  <div class="flex items-center gap-3">
                    <span class="flex items-center gap-1" title="Free delivery">
                      <span class="text-green-500">🚚</span>
                      <span>Free delivery</span>
                    </span>
                    <span class="flex items-center gap-1" title="Mobile money payment">
                      <span class="text-blue-500">💳</span>
                      <span>Mobile Money</span>
                    </span>
                  </div>
                  <span class="flex items-center gap-1" title="Secure transaction">
                    <span class="text-green-500">🔒</span>
                    <span>Secure</span>
                  </span>
                </div>
              </div>
            </div>
          </div>
        `).join('');

        // Update results count
        updateFilterSummary();
      }

      // Wishlist functionality
      function toggleWishlist(productId) {
        console.log('🤍 Toggling wishlist for product:', productId);

        const index = wishlist.indexOf(productId);
        if (index > -1) {
          wishlist.splice(index, 1);
        } else {
          wishlist.push(productId);
        }

        localStorage.setItem('rwanda-wishlist', JSON.stringify(wishlist));

        // Update UI
        const icon = document.getElementById(`wishlist-icon-${productId}`);
        if (icon) {
          icon.textContent = wishlist.includes(productId) ? '❤️' : '🤍';
          icon.className = `text-lg ${wishlist.includes(productId) ? 'text-red-500' : 'text-neutral-600'}`;
        }

        // Show notification
        showNotification(wishlist.includes(productId) ? 'Added to wishlist ❤️' : 'Removed from wishlist 🤍');
      }

      // Recently viewed functionality
      function addToRecentlyViewed(productId) {
        console.log('👁️ Adding to recently viewed:', productId);

        const index = recentlyViewed.indexOf(productId);
        if (index > -1) {
          recentlyViewed.splice(index, 1);
        }
        recentlyViewed.unshift(productId);

        // Keep only last 10 items
        recentlyViewed = recentlyViewed.slice(0, 10);

        localStorage.setItem('rwanda-recently-viewed', JSON.stringify(recentlyViewed));
        updateRecentlyViewedDisplay();
      }

      // Update recently viewed display
      function updateRecentlyViewedDisplay() {
        const container = document.getElementById('recentlyViewed');
        if (!container) return;

        if (recentlyViewed.length === 0) {
          container.innerHTML = `
            <p class="text-sm text-neutral-500">No recently viewed products</p>
            <p class="text-xs text-neutral-400">Products you view will appear here</p>
          `;
          return;
        }

        const recentProducts = recentlyViewed.map(id => originalProducts.find(p => p._id === id)).filter(Boolean).slice(0, 3);

        container.innerHTML = recentProducts.map(product => `
          <div class="flex items-center gap-3 p-3 bg-neutral-50 rounded-xl hover:bg-neutral-100 transition-colors duration-200">
            <div class="w-10 h-10 bg-neutral-200 rounded-lg flex items-center justify-center text-lg">
              ${getProductIcon(product.name)}
            </div>
            <div class="flex-1">
              <div class="font-semibold text-neutral-900 text-sm truncate">${product.name}</div>
              <div class="text-xs text-neutral-600">${product.price.toLocaleString()} RWF</div>
            </div>
            <a href="/product/${product._id}" class="text-primary hover:text-primary-600 text-sm font-medium">View</a>
          </div>
        `).join('');
      }

      // Cart functionality
      function addToCart(productId, productName) {
        console.log('🛒 Adding to cart:', productId, productName);

        if (!isAuthenticated) {
          window.location.href = '/login';
          return;
        }

        // Create form and submit
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/cart/add';

        const productInput = document.createElement('input');
        productInput.type = 'hidden';
        productInput.name = 'productId';
        productInput.value = productId;

        const quantityInput = document.createElement('input');
        quantityInput.type = 'hidden';
        quantityInput.name = 'quantity';
        quantityInput.value = '1';

        form.appendChild(productInput);
        form.appendChild(quantityInput);
        document.body.appendChild(form);
        form.submit();

        showNotification(`Added ${productName} to cart 🛒`);
      }

      function addToCartQuick(productId) {
        addToCart(productId, 'Product');
      }

      // Clear functions
      function clearSearch() {
        document.getElementById('productSearch').value = '';
        applyFilters();
      }

      function clearAllFilters() {
        console.log('🗑️ Clearing all filters');

        document.getElementById('productSearch').value = '';
        document.getElementById('categoryFilter').value = '';
        document.getElementById('priceRangeFilter').value = '';
        document.getElementById('sortFilter').value = 'featured';
        document.getElementById('showOnlyInStock').checked = false;
        document.getElementById('showOnlyFeatured').checked = false;

        // Reset category selection
        currentCategory = '';
        document.querySelectorAll('.category-btn').forEach(btn => {
          btn.classList.remove('border-primary', 'bg-primary', 'bg-opacity-5');
          if (btn.classList.contains('category-btn-all')) {
            btn.classList.add('border-primary', 'bg-primary', 'bg-opacity-5');
          }
        });

        filteredProducts = [...originalProducts];
        renderProductsGrid();
      }

      // Empty state management
      function showNoResultsState() {
        document.getElementById('noResultsState').classList.remove('hidden');
        document.getElementById('noProductsState').classList.add('hidden');
        document.getElementById('productsGrid').innerHTML = '';
      }

      function hideEmptyStates() {
        document.getElementById('noResultsState').classList.add('hidden');
        document.getElementById('noProductsState').classList.add('hidden');
      }

      // Notification system
      function showNotification(message) {
        // Remove existing notification
        const existing = document.querySelector('.notification-toast');
        if (existing) {
          existing.remove();
        }

        const notification = document.createElement('div');
        notification.className = 'notification-toast fixed top-4 right-4 bg-neutral-900 text-white px-6 py-3 rounded-xl shadow-lg z-50 transform translate-x-full transition-transform duration-300';
        notification.textContent = message;

        document.body.appendChild(notification);

        // Animate in
        setTimeout(() => {
          notification.classList.remove('translate-x-full');
        }, 100);

        // Animate out and remove
        setTimeout(() => {
          notification.classList.add('translate-x-full');
          setTimeout(() => {
            notification.remove();
          }, 300);
        }, 3000);
      }

      // Event listeners
      document.getElementById('productSearch').addEventListener('input', applyFilters);
      document.getElementById('categoryFilter').addEventListener('change', applyFilters);
      document.getElementById('priceRangeFilter').addEventListener('change', applyFilters);
      document.getElementById('sortFilter').addEventListener('change', applyFilters);
      document.getElementById('showOnlyInStock').addEventListener('change', applyFilters);
      document.getElementById('showOnlyFeatured').addEventListener('change', applyFilters);

      // Enhanced animation initialization
      function initializeAnimations() {
        console.log('🎨 Initializing enhanced animations');

        // Initialize AOS with enhanced settings
        if (typeof AOS !== 'undefined') {
          AOS.init({
            duration: 800,
            easing: 'ease-out-cubic',
            once: true,
            offset: 100,
            delay: 0,
            anchorPlacement: 'top-bottom'
          });
        }

        // Add floating animation to category cards
        const categoryCards = document.querySelectorAll('.category-card');
        categoryCards.forEach((card, index) => {
          card.style.animationDelay = `${index * 0.1}s`;
          card.classList.add('animate-float-slow');
        });

        // Add staggered animation to supplier cards
        const supplierCards = document.querySelectorAll('.supplier-card');
        supplierCards.forEach((card, index) => {
          card.style.animationDelay = `${index * 0.2}s`;
          card.classList.add('animate-glow-subtle');
        });

        // Add parallax effect to background elements
        addParallaxEffect();
      }

      // Parallax effect for background elements
      function addParallaxEffect() {
        window.addEventListener('scroll', () => {
          const scrolled = window.pageYOffset;
          const parallaxElements = document.querySelectorAll('.animate-float-slow');

          parallaxElements.forEach((element, index) => {
            const speed = 0.5 + (index * 0.1);
            const yPos = -(scrolled * speed);
            element.style.transform = `translateY(${yPos}px)`;
          });
        });
      }

      // Enhanced category filtering with animations
      function filterByCategory(categoryId) {
        console.log('🏷️ Filtering by category:', categoryId);

        // Add loading animation
        const productsGrid = document.getElementById('productsGrid');
        productsGrid.style.opacity = '0.7';
        productsGrid.style.transform = 'scale(0.95)';
        productsGrid.style.transition = 'all 0.3s ease';

        setTimeout(() => {
          // Update current category
          currentCategory = categoryId;

          // Update button states with enhanced animation
          document.querySelectorAll('.category-btn').forEach(btn => {
            btn.classList.remove('border-primary', 'bg-primary', 'bg-opacity-5', 'animate-pulse');
            if (btn.dataset.category === categoryId) {
              btn.classList.add('border-primary', 'bg-primary', 'bg-opacity-5', 'animate-pulse');
            } else if (categoryId === '' && btn.classList.contains('category-btn-all')) {
              btn.classList.add('border-primary', 'bg-primary', 'bg-opacity-5', 'animate-pulse');
            }
          });

          // Apply all filters including category
          applyFilters();

          // Remove loading animation
          setTimeout(() => {
            productsGrid.style.opacity = '1';
            productsGrid.style.transform = 'scale(1)';
          }, 150);
        }, 200);
      }

      // Initialize on page load
      document.addEventListener('DOMContentLoaded', function() {
        console.log('🚀 Initializing enhanced products page');

        // Initialize enhanced animations
        initializeAnimations();

        // Initialize recently viewed
        updateRecentlyViewedDisplay();

        // Initial render
        applyFilters();

        // Add smooth scrolling for better UX
        document.documentElement.style.scrollBehavior = 'smooth';

        console.log('✅ Enhanced products page initialized');
      });
    </script>

<%- include('../partials/footer') %>